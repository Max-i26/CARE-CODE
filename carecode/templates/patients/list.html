{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="fw-bold text-primary">Patients</h3>

  {% if current_user_type == 'ministry' and not current_hospital_id %}
    <button class="btn btn-success fw-bold shadow-sm" disabled title="Please select a hospital first">
      + Add Patient
    </button>
  {% else %}
    <a href="{{ url_for('add_patient') }}" class="btn btn-success fw-bold shadow-sm">
      + Add Patient
    </a>
  {% endif %}
</div>

<!-- Hospital Selection for Ministry Users -->
{% if current_user_type == 'ministry' and not current_hospital_id %}
<div class="alert alert-warning mb-4">
  <h5 class="alert-heading">Select Hospital</h5>
  <p>Please select a hospital to manage patients:</p>
  <div class="row">
    {% if hospitals %}
      {% for hospital in hospitals %}
      <div class="col-md-4 mb-2">
        <a href="{{ url_for('patients') }}?hospital_id={{ hospital.id }}" class="btn btn-outline-primary w-100">
          {{ hospital.name }}
        </a>
      </div>
      {% endfor %}
    {% else %}
      <div class="col-12">
        <p class="text-muted">No hospitals available. Please add a hospital first.</p>
        <a href="{{ url_for('hospitals') }}" class="btn btn-primary">Manage Hospitals</a>
      </div>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- Current Hospital Display -->
{% if current_hospital_id or (current_user_type == 'hospital_admin' and current_hospital_id) %}
<div class="card mb-3 border-primary">
  <div class="card-body py-2">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <small class="text-muted">Current Hospital:</small>
        <strong class="ms-2 text-primary">
          {% if current_hospital %}
            {{ current_hospital.name }}
          {% elif current_hospital_id %}
            Hospital ID: {{ current_hospital_id }}
          {% else %}
            Unknown Hospital
          {% endif %}
        </strong>
      </div>
      {% if current_user_type == 'ministry' %}
        <a href="{{ url_for('patients') }}" class="btn btn-sm btn-outline-secondary">Change Hospital</a>
      {% endif %}
    </div>
  </div>
</div>
{% endif %}

<form method="GET" class="mb-4">
  {{ search_form.hidden_tag() }}
  {% if request.args.get('hospital_id') %}
    <input type="hidden" name="hospital_id" value="{{ request.args.get('hospital_id') }}">
  {% endif %}
  <div class="row g-2">
    <div class="col-md-8">
      {{ search_form.search_term(class="form-control", placeholder="Search patients...") }}
    </div>
    <div class="col-md-3">
      {{ search_form.search_type(class="form-select") }}
    </div>
    <div class="col-md-1">
      {{ search_form.submit(class="btn btn-primary w-100") }}
    </div>
  </div>
</form>

{% if patients %}
  <div class="table-responsive">
    <table class="table table-hover align-middle shadow-sm">
      <thead class="table-primary">
        <tr>
          <th>Name</th>
          <th>DOB</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Blood Type</th>
          <th>Hospital</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for patient in patients %}
        <tr>
          <td>
            <strong>{{ patient.full_name }}</strong>
            {% if patient.guardian_number %}
              <br><small class="text-muted">Guardian: {{ patient.guardian_number }}</small>
            {% endif %}
          </td>
          <td>{{ patient.date_of_birth.strftime("%Y-%m-%d") if patient.date_of_birth else "—" }}</td>
          <td>{{ patient.email or "—" }}</td>
          <td>
            {% if patient.contact_info and patient.contact_info.phone_primary %}
              {{ patient.contact_info.phone_primary }}
              {% if patient.contact_info.phone_secondary %}
                <br><small class="text-muted">{{ patient.contact_info.phone_secondary }}</small>
              {% endif %}
            {% else %}
              —
            {% endif %}
          </td>
          <td>
            {% if patient.blood_type %}
              <span class="badge bg-info">{{ patient.blood_type }}</span>
            {% else %}
              —
            {% endif %}
          </td>
          <td>
            {% if patient.hospital %}
              <small class="text-muted">{{ patient.hospital.name }}</small>
            {% else %}
              <small class="text-warning">Unknown</small>
            {% endif %}
          </td>
          <td>
            <div class="btn-group" role="group">
              <a href="{{ url_for('patient_detail', patient_id=patient.id) }}"
                 class="btn btn-sm btn-outline-primary" title="View Details">
                <i class="fas fa-eye"></i>
              </a>
              <a href="{{ url_for('edit_patient', patient_id=patient.id) }}"
                 class="btn btn-sm btn-outline-secondary" title="Edit">
                <i class="fas fa-edit"></i>
              </a>
              {% if current_user_type == 'doctor' %}
              <a href="{{ url_for('add_encounter', patient_id=patient.id) }}"
                 class="btn btn-sm btn-outline-success" title="Add Encounter">
                <i class="fas fa-plus-circle"></i>
              </a>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination Info -->
  {% if patients|length >= 50 %}
  <div class="alert alert-info">
    <small>Showing first 50 results. Use search filters to narrow down results.</small>
  </div>
  {% endif %}

{% else %}
  <div class="alert alert-info">
    <h5 class="alert-heading">No patients found</h5>
    {% if search_form.search_term.data %}
      <p>No patients match your search criteria. Try:</p>
      <ul>
        <li>Using different search terms</li>
        <li>Checking spelling</li>
        <li>Searching in all fields</li>
      </ul>
      <a href="{{ url_for('patients') }}" class="btn btn-sm btn-outline-primary">Clear Search</a>
    {% else %}
      <p>No patients have been registered yet.</p>
      {% if current_hospital_id %}
        <a href="{{ url_for('add_patient') }}" class="btn btn-primary">Add First Patient</a>
      {% endif %}
    {% endif %}
  </div>
{% endif %}

<!-- Quick Stats -->
{% if patients %}
<div class="row mt-4">
  <div class="col-md-12">
    <div class="card">
      <div class="card-body">
        <h6 class="card-title text-muted">Quick Stats</h6>
        <div class="row text-center">
          <div class="col">
            <strong>{{ patients|length }}</strong>
            <br><small class="text-muted">Patients Shown</small>
          </div>
          {% if current_user_type in ['hospital_admin', 'ministry'] %}
          <div class="col">
            <strong>{{ patients|selectattr('blood_type')|list|length }}</strong>
            <br><small class="text-muted">With Blood Type</small>
          </div>
          <div class="col">
            <strong>{{ patients|selectattr('email')|list|length }}</strong>
            <br><small class="text-muted">With Email</small>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}